// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                String   @id @default(uuid())
  name              String
  email             String   @unique
  subscriptionPlan  String?  @map("subscription_plan") // 'basic', 'pro', 'enterprise'
  status            String   @default("active") // 'active', 'suspended', 'trial'
  createdAt         DateTime @default(now()) @map("created_at")

  users             User[]
  instances         Instance[]
  campaigns         Campaign[]
  messages          Message[]
  billing           Billing[]

  @@map("tenants")
}

model User {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  email        String
  passwordHash String   @map("password_hash")
  role         String   // 'admin', 'agent', 'viewer'
  createdAt    DateTime @default(now()) @map("created_at")

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("users")
}

model Instance {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  instanceName String   @map("instance_name")
  phoneNumber  String?  @map("phone_number")
  status       String   // 'connected', 'disconnected', 'qr_pending'
  qrCode       String?  @map("qr_code") @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  campaigns    Campaign[]
  messages     Message[]
  campaignInstances CampaignInstance[]

  @@map("instances")
}

model Campaign {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  instanceId      String?   @map("instance_id") // Made optional for multi-instance campaigns
  name            String
  messageTemplate String    @map("message_template") @db.Text
  status          String    // 'draft', 'scheduled', 'running', 'completed'
  totalContacts   Int       @default(0) @map("total_contacts")
  sentCount       Int       @default(0) @map("sent_count")
  failedCount     Int       @default(0) @map("failed_count")
  delayMin        Int       @default(5) @map("delay_min")   // Min delay in seconds
  delayMax        Int       @default(15) @map("delay_max")  // Max delay in seconds
  instanceSwitchCount Int     @default(50) @map("instance_switch_count") // Switch instance every N messages
  messageRotationCount Int    @default(1) @map("message_rotation_count") // Switch template every N messages
  scheduledAt     DateTime? @map("scheduled_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  instance      Instance? @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  messages      Message[]
  campaignInstances CampaignInstance[]
  messageTemplates MessageTemplate[]

  @@map("campaigns")
}

model MessageTemplate {
  id          String   @id @default(uuid())
  campaignId  String   @map("campaign_id")
  content     String   @db.Text
  orderIndex  Int      @map("order_index")

  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("message_templates")
}

model CampaignInstance {
  id          String   @id @default(uuid())
  campaignId  String   @map("campaign_id")
  instanceId  String   @map("instance_id")
  orderIndex  Int      @map("order_index")

  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  instance    Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@map("campaign_instances")
}

model Message {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  campaignId      String?   @map("campaign_id")
  instanceId      String    @map("instance_id")
  recipientNumber String    @map("recipient_number")
  messageText     String    @map("message_text") @db.Text
  status          String    // 'pending', 'sent', 'delivered', 'failed'
  sentAt          DateTime? @map("sent_at")
  deliveredAt     DateTime? @map("delivered_at")

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  campaign        Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  instance        Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Billing {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  periodStart  DateTime @map("period_start") @db.Date
  periodEnd    DateTime @map("period_end") @db.Date
  messagesCount Int     @default(0) @map("messages_count")
  amountDue    Decimal  @map("amount_due") @db.Decimal(10, 2)
  status       String   // 'pending', 'paid', 'overdue'

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("billing")
}
